# ========= OpenMesh GoMobile Build =========
# Build iOS XCFramework (device + simulator) for Xcode

#
# ä½ è¦ç»‘å®šçš„ Go packagesï¼ˆgomobile bind æ”¯æŒå¤šä¸ª packagesï¼Œä¸€æ¬¡ç”Ÿæˆä¸€ä¸ª Framework/XCFrameworkï¼‰
#
# é»˜è®¤ PKGSï¼šlibboxï¼ˆVPNï¼‰+ go-cli-lib/interfaceï¼ˆé’±åŒ… AppLibï¼‰ï¼Œä¸€ä¸ª OpenMeshGo.xcframework åŒæ—¶ä¾› VPN ä¸åˆ›å»ºé’±åŒ…ä½¿ç”¨ã€‚
# è‹¥åªéœ€ libboxï¼ˆä»… VPNã€äº§ç‰©æ›´å°ï¼‰ï¼Œå¯ make apple-libbox-onlyã€‚
#
PKGS           ?= github.com/sagernet/sing-box/experimental/libbox github.com/MeshNetProtocol/openmesh-cli/go-cli-lib/interface

# Apple bindï¼šåœ¨æœ¬ module æ ¹ç›®å½•æ‰§è¡Œï¼ˆgo-cli-lib çš„ go.mod å·² require sing-boxï¼‰ã€‚
APPLE_BIND_DIR ?= .
APPLE_PKGS     ?= $(PKGS)

# ç”¨å¯è®¿é—®çš„ GOPROXYï¼ˆé¿å… goproxy.io / goproxy.cn å¯¹æŸäº›æ¨¡å— 404 æˆ– DNS/TLS ä¸ç¨³å®šï¼‰
# proxy.golang.org æ˜¯ Go å®˜æ–¹ä»£ç†ï¼Œå…¼å®¹æ€§æœ€å¥½
APPLE_GOPROXY  ?= https://proxy.golang.org,direct
APPLE_GOSUMDB  ?= sum.golang.org

# Some environments set GOFLAGS=-mod=readonly globally, and gomobile may inherit it.
# Allow module graph updates in gomobile's temporary work dirs.
APPLE_GOFLAGS  ?= -mod=mod
# é»˜è®¤å¼€å¯è¯¦ç»†æ—¥å¿—ï¼šgomobile ä¼  -v -xï¼›ç”¨ VERBOSE=0 å¯å…³é—­
VERBOSE        ?= 1
GOMOBILE_VERBOSE :=
ifneq ($(VERBOSE),)
ifneq ($(VERBOSE),0)
GOMOBILE_VERBOSE := -v -x
endif
endif

# å¹¶è¡Œç¼–è¯‘ä¼˜åŒ–
# ä½¿ç”¨æ‰€æœ‰å¯ç”¨çš„CPUæ ¸å¿ƒ
GOMAXPROCS     ?= $(shell sysctl -n hw.ncpu 2>/dev/null || echo 4)

# Goç¼–è¯‘åŠ é€Ÿæ ‡å¿—
GO_BUILD_FLAGS ?= -buildmode=c-archive

# å†…å­˜é™åˆ¶ï¼ˆé˜²æ­¢ç¼–è¯‘æ—¶å†…å­˜ä¸è¶³ï¼‰
GOGC          ?= 100

# è¾“å‡ºç›®å½•ä¸äº§ç‰©å
IOS_OUTPUT_DIR     ?= ./lib/ios
MACOS_OUTPUT_DIR   ?= ./lib/macos
ANDROID_OUTPUT_DIR ?= ./lib/android
FRAMEWORK_NAME     ?= OpenMeshGo
FRAMEWORK_BUNDLE_ID ?= com.meshnetprotocol.OpenMeshGo
IOS_XCFRAMEWORK    := $(IOS_OUTPUT_DIR)/$(FRAMEWORK_NAME).xcframework
MACOS_XCFRAMEWORK  := $(MACOS_OUTPUT_DIR)/$(FRAMEWORK_NAME).xcframework

# Absolute output path for gomobile when running from another module dir.
APPLE_XCFRAMEWORK_ABS := $(abspath ./lib/$(FRAMEWORK_NAME).xcframework)
# make apple æ„å»ºå mv åˆ°æ­¤ç›®å½•ï¼Œä¿è¯ Xcode åªç”¨ä¸€ä»½æœ€æ–° frameworkï¼Œé¿å…æ—§ç¼“å­˜å¯¼è‡´æ’æŸ¥å›°éš¾ã€‚
OPENMESH_APPLE_LIB  := $(CURDIR)/../openmesh-apple/lib

# æœ€ä½ iOS ç‰ˆæœ¬ï¼ˆä½ çš„ App ç›®æ ‡ iOS15+ï¼‰
IOS_VERSION    ?= 15.0

# macOS ç‰ˆæœ¬
MACOS_VERSION  ?= 13.0

# ObjC ç¬¦å·å‰ç¼€ï¼ˆé¿å…å’Œå…¶å®ƒåº“å†²çªï¼›æƒ³æ¢ä¹Ÿè¡Œï¼Œæ¯”å¦‚ OMï¼‰
OBJC_PREFIX    ?= OM

# Go build tags (comma-separated recommended for gomobile, e.g. "with_gvisor,with_clash_api").
#
# Goal: Keep our VPN/libbox behavior fully aligned with upstream sing-box.
# Upstream reference:
#   sing-box/cmd/internal/build_libbox/main.go (sharedTags + darwinTags)
#
# Notes:
# - Some features are only used on specific platforms in upstream (e.g. low_memory, tailscale),
#   but gomobile bind here uses a single tag set across Apple targets; we include the upstream
#   feature tags directly to minimize "feature not included" runtime failures.
# NOTE: sing-box upstream includes `badlinkname`, but that tag activates go1.25-only
# linkname hooks in `sing-box/common/badtls/*` which break on Go 1.25.x (linker error
# against `crypto/tls.(*Conn).handlePostHandshakeMessage`).
# Until we build with Go 1.24.x (upstream's go.mod), keep `badlinkname` disabled here.
#
# IMPORTANT (macOS NetworkExtension / app extension):
# `with_naive_outbound` pulls in cronet-go (Chromium/Cronet), which depends on AppKit
# symbols like NSApp / NSApplication. App extensions are built with -fapplication-extension
# and must not link AppKit, otherwise you'll hit undefined symbols / app-extension API violations.
#
# So for system/app extensions we keep GO_TAGS "extension-safe" by default.
# If you really need naive outbound (Cronet), build a separate non-extension variant.
GO_TAGS        ?= with_gvisor,with_quic,with_dhcp,with_wireguard,with_utls,with_clash_api,with_conntrack,tfogo_checklinkname0

ifneq ($(strip $(GO_TAGS)),)
GOMOBILE_TAGS_FLAG := -tags=$(GO_TAGS)
endif

# Match sing-box cmd/internal/build_libbox: -trimpath, -buildvcs=false, -ldflags -buildid=
# Keep symbols by default so App Store archive can include framework symbols.
# Set STRIP_SYMBOLS=1 for local size-focused builds.
STRIP_SYMBOLS   ?= 0
APPLE_LDFLAGS   ?= -buildid=
ifeq ($(STRIP_SYMBOLS),1)
APPLE_LDFLAGS   += -s -w
endif
APPLE_EXTRA_FLAGS := -trimpath -buildvcs=false -ldflags "$(APPLE_LDFLAGS)"
# Gomobile (sagernet) already produces frameworks with root containing only symlinks
# (Headers, <title>, Resources, Modules -> Versions/Current/...) and Info.plist only in
# Versions/A/Resources/. No post-step needed for Apple 90238.

# Go / Tooling
GO             ?= go
GOPATH         := $(shell $(GO) env GOPATH)
GOMOBILE       := $(GOPATH)/bin/gomobile
GOBIND         := $(GOPATH)/bin/gobind

# Apple platforms: ios,iossimulator,macos,maccatalyst (comma-delimited)
IOS_TARGETS    ?= ios,iossimulator
MACOS_TARGETS  ?= macos
# ç›®æ ‡ï¼šä¸€ä¸ª XCFramework åŒæ—¶åŒ…å« iOS + Simulator + macOS slices
APPLE_TARGETS  ?= $(IOS_TARGETS),$(MACOS_TARGETS)

.PHONY: all doctor tools gomobile-init apple apple-libbox-only apple-clean ios ios-fast-sim macos macos-all android clean test help

all: apple

doctor:
	@echo "== go =="
	@$(GO) version
	@echo "== xcode =="
	@xcodebuild -version
	@echo "== xcode-select =="
	@xcode-select -p
	@echo "== gomobile =="
	@([ -x "$(GOMOBILE)" ] && $(GOMOBILE) version) || echo "gomobile not installed (run: make tools)"

tools:
	@if [ ! -x "$(GOMOBILE)" ] || [ ! -x "$(GOBIND)" ]; then \
		echo "Installing gomobile/gobind (sagernet fork, required for iossimulator/tvossimulator tags)..."; \
		GOPROXY="$(APPLE_GOPROXY)" GOSUMDB="$(APPLE_GOSUMDB)" $(GO) install github.com/sagernet/gomobile/cmd/gomobile@v0.1.11; \
		GOPROXY="$(APPLE_GOPROXY)" GOSUMDB="$(APPLE_GOSUMDB)" $(GO) install github.com/sagernet/gomobile/cmd/gobind@v0.1.11; \
		echo "gomobile installed at: $(GOMOBILE)"; \
		go version -m "$(GOMOBILE)" 2>/dev/null | sed -n '1,12p' || true; \
		echo "gobind installed at: $(GOBIND)"; \
		go version -m "$(GOBIND)" 2>/dev/null | sed -n '1,12p' || true; \
	else \
		echo "gomobile/gobind already installed, skipping update."; \
		echo "  gomobile: $(GOMOBILE)"; \
		echo "  gobind: $(GOBIND)"; \
		echo "  (set FORCE_UPDATE_TOOLS=1 to force reinstall)"; \
	fi

gomobile-init: tools
	@if [ "$(FORCE_GOMOBILE_INIT)" = "1" ]; then \
		echo "Forcing gomobile init..."; \
		rm -rf "$(GOPATH)/pkg/gomobile"; \
		$(GOMOBILE) init; \
	elif ! go version -m "$(GOMOBILE)" 2>/dev/null | grep -q "github.com/sagernet/gomobile"; then \
		echo "Detected non-sagernet gomobile; forcing re-init to enable iossimulator/tvossimulator build tags..."; \
		rm -rf "$(GOPATH)/pkg/gomobile"; \
		$(GOMOBILE) init; \
	elif [ -d "$(GOPATH)/pkg/gomobile" ]; then \
		echo "gomobile toolchain already initialized: $(GOPATH)/pkg/gomobile"; \
		echo "  (set FORCE_GOMOBILE_INIT=1 to re-init)"; \
	else \
		echo "Initializing gomobile toolchain..."; \
		$(GOMOBILE) init; \
	fi

# Set FORCE_GO_CACHE_CLEAN=1 to run 'go clean -cache' before bind (ensures latest Go code is used).
FORCE_GO_CACHE_CLEAN ?= 0

# ä¸€æ¬¡æ€§ç”ŸæˆåŒ…å« ios+sim+macos çš„ OpenMeshGo.xcframework
apple: gomobile-init
	@mkdir -p ./lib
	@rm -rf ./lib/$(FRAMEWORK_NAME).xcframework
	@echo "Cleaning previous build artifacts in $(APPLE_BIND_DIR)/build..."
	@rm -rf "$(APPLE_BIND_DIR)/build"
	@if [ "$(FORCE_GO_CACHE_CLEAN)" = "1" ]; then \
		echo "FORCE_GO_CACHE_CLEAN=1: running go clean -cache..."; \
		$(GO) clean -cache; \
	fi
	@echo "Building Unified Apple XCFramework => ./lib/$(FRAMEWORK_NAME).xcframework"
	@echo "  BIND_DIR: $(APPLE_BIND_DIR)"
	@echo "  PKGS: $(APPLE_PKGS)"
	@echo "  TARGETS: $(APPLE_TARGETS)"
	@echo "  GO_TAGS: $(GO_TAGS)"
	@if [ -n "$(VERBOSE)" ] && [ "$(VERBOSE)" != "0" ]; then echo "  GOMOBILE_VERBOSE: $(GOMOBILE_VERBOSE)"; echo "  Running: $(GOMOBILE) bind $(GOMOBILE_VERBOSE) -target=... (output may stream slowly)..."; fi
	@cd "$(APPLE_BIND_DIR)" && MACOSX_DEPLOYMENT_TARGET=$(MACOS_VERSION) \
		GOMAXPROCS=$(GOMAXPROCS) GOGC=$(GOGC) \
		GOPROXY="$(APPLE_GOPROXY)" GOSUMDB="$(APPLE_GOSUMDB)" GOFLAGS="$(APPLE_GOFLAGS)" \
		$(GOMOBILE) bind $(GOMOBILE_VERBOSE) \
		-target=$(APPLE_TARGETS) \
		-iosversion=$(IOS_VERSION) \
		-prefix=$(OBJC_PREFIX) \
		$(APPLE_EXTRA_FLAGS) \
		$(GOMOBILE_TAGS_FLAG) \
		-o "$(APPLE_XCFRAMEWORK_ABS)" \
		$(APPLE_PKGS)
	@echo "Flattening framework structure for iOS slices only (keep macOS framework versioned layout)..."
	@XCFW="$(CURDIR)/lib/$(FRAMEWORK_NAME).xcframework"; \
	for fw in $$XCFW/*/$(FRAMEWORK_NAME).framework; do \
		[ -d "$$fw" ] || continue; \
		slice_dir="$$(basename "$$(dirname "$$fw")")"; \
		case "$$slice_dir" in \
			ios-*|*simulator*) \
				echo "  Flattening $$fw ($$slice_dir)"; \
				$(CURDIR)/../flatten_framework.sh "$$fw"; \
				if [ -f "$$fw/Resources/Info.plist" ]; then \
					cp "$$fw/Resources/Info.plist" "$$fw/Info.plist"; \
					echo "  Synced root Info.plist for $$fw"; \
				fi; \
				;; \
			*) \
				echo "  Skip flatten for $$fw ($$slice_dir)"; \
				;; \
		esac; \
	done
	@echo "Normalizing framework Info.plist keys (preserve gomobile-generated keys, ensure iOS min version exists)..."
	@XCFW="$(CURDIR)/lib/$(FRAMEWORK_NAME).xcframework"; \
	for fw in $$XCFW/*/$(FRAMEWORK_NAME).framework; do \
		[ -d "$$fw" ] || continue; \
		slice_dir="$$(basename "$$(dirname "$$fw")")"; \
		min_os=""; \
		case "$$slice_dir" in \
			ios-*|*simulator*) min_os="$(IOS_VERSION)" ;; \
		esac; \
		for plist in "$$fw/Info.plist" "$$fw/Resources/Info.plist" "$$fw/Versions/A/Resources/Info.plist"; do \
			[ -f "$$plist" ] || continue; \
			/usr/libexec/PlistBuddy -c "Set :CFBundleIdentifier $(FRAMEWORK_BUNDLE_ID)" "$$plist" 2>/dev/null || /usr/libexec/PlistBuddy -c "Add :CFBundleIdentifier string $(FRAMEWORK_BUNDLE_ID)" "$$plist"; \
			/usr/libexec/PlistBuddy -c "Set :CFBundleExecutable $(FRAMEWORK_NAME)" "$$plist" 2>/dev/null || /usr/libexec/PlistBuddy -c "Add :CFBundleExecutable string $(FRAMEWORK_NAME)" "$$plist"; \
			/usr/libexec/PlistBuddy -c "Set :CFBundleName $(FRAMEWORK_NAME)" "$$plist" 2>/dev/null || /usr/libexec/PlistBuddy -c "Add :CFBundleName string $(FRAMEWORK_NAME)" "$$plist"; \
			/usr/libexec/PlistBuddy -c "Set :CFBundlePackageType FMWK" "$$plist" 2>/dev/null || /usr/libexec/PlistBuddy -c "Add :CFBundlePackageType string FMWK" "$$plist"; \
			if [ -n "$$min_os" ]; then \
				/usr/libexec/PlistBuddy -c "Set :MinimumOSVersion $$min_os" "$$plist" 2>/dev/null || /usr/libexec/PlistBuddy -c "Add :MinimumOSVersion string $$min_os" "$$plist"; \
			fi; \
			echo "  Patched $$plist"; \
		done; \
	done
	@echo "Normalizing XCFramework BinaryPath for flattened iOS slices..."
	@XCFW="$(CURDIR)/lib/$(FRAMEWORK_NAME).xcframework"; \
	XCFW_PLIST="$$XCFW/Info.plist"; \
	if [ -f "$$XCFW_PLIST" ]; then \
		count="$$(/usr/libexec/PlistBuddy -c 'Print :AvailableLibraries' "$$XCFW_PLIST" 2>/dev/null | grep -c 'Dict {' || true)"; \
		if [ -n "$$count" ] && [ "$$count" -gt 0 ]; then \
			i=0; \
			while [ "$$i" -lt "$$count" ]; do \
				platform="$$(/usr/libexec/PlistBuddy -c "Print :AvailableLibraries:$$i:SupportedPlatform" "$$XCFW_PLIST" 2>/dev/null || true)"; \
				if [ "$$platform" = "ios" ]; then \
					/usr/libexec/PlistBuddy -c "Set :AvailableLibraries:$$i:BinaryPath $(FRAMEWORK_NAME).framework/$(FRAMEWORK_NAME)" "$$XCFW_PLIST" 2>/dev/null || true; \
					echo "  Set iOS BinaryPath at AvailableLibraries:$$i"; \
				fi; \
				i=$$((i + 1)); \
			done; \
		fi; \
	fi
	@echo "Moving framework to openmesh-apple/lib (rm old + mv new, single source of truth)..."
	@rm -rf "$(OPENMESH_APPLE_LIB)/$(FRAMEWORK_NAME).xcframework"
	@mkdir -p "$(OPENMESH_APPLE_LIB)"
	@mv "$(CURDIR)/lib/$(FRAMEWORK_NAME).xcframework" "$(OPENMESH_APPLE_LIB)/"
	@echo "âœ… Done: $(OPENMESH_APPLE_LIB)/$(FRAMEWORK_NAME).xcframework"
	@XCFW="$(OPENMESH_APPLE_LIB)/$(FRAMEWORK_NAME).xcframework"; \
	if [ -d "$$XCFW/macos-arm64_x86_64" ]; then \
		BIN="$$XCFW/macos-arm64_x86_64/$(FRAMEWORK_NAME).framework/$(FRAMEWORK_NAME)"; \
		if [ -f "$$BIN" ]; then \
			echo "  macOS slice mtime: $$(stat -f '%Sm' -t '%Y-%m-%d %H:%M:%S' "$$BIN" 2>/dev/null || stat -c '%y' "$$BIN" 2>/dev/null | cut -d. -f1)"; \
		fi; \
	fi
	@echo "  If CFPrefs or stale behavior persists: run 'make clean && make apple FORCE_GO_CACHE_CLEAN=1', then in Xcode: Product > Clean Build Folder (Shift+Cmd+K), then build."

# å¿«é€Ÿå¼€å‘æ„å»ºï¼ˆä»…iOSæ¨¡æ‹Ÿå™¨ï¼Œç”¨äºå¿«é€Ÿè¿­ä»£ï¼‰
apple-fast-sim: gomobile-init
	@mkdir -p ./lib
	@rm -rf ./lib/$(FRAMEWORK_NAME).xcframework
	@rm -rf "$(APPLE_BIND_DIR)/build"
	@echo "ğŸš€ Fast build for iOS Simulator only (development) => ./lib/$(FRAMEWORK_NAME).xcframework"
	@cd "$(APPLE_BIND_DIR)" && MACOSX_DEPLOYMENT_TARGET=$(MACOS_VERSION) \
		GOMAXPROCS=$(GOMAXPROCS) GOGC=$(GOGC) \
		GOPROXY="$(APPLE_GOPROXY)" GOSUMDB="$(APPLE_GOSUMDB)" GOFLAGS="$(APPLE_GOFLAGS)" \
		$(GOMOBILE) bind $(GOMOBILE_VERBOSE) \
		-target=iossimulator \
		-iosversion=$(IOS_VERSION) \
		-prefix=$(OBJC_PREFIX) \
		-ldflags="-s -w" \
		$(GOMOBILE_TAGS_FLAG) \
		-o "$(APPLE_XCFRAMEWORK_ABS)" \
		$(APPLE_PKGS)
	@echo "Injecting CFBundleIdentifier/CFBundleExecutable into framework Info.plist..."
	@XCFW="$(CURDIR)/lib/$(FRAMEWORK_NAME).xcframework"; \
	SRC_PLIST="$(CURDIR)/../openmesh-apple/OpenMeshGo-Framework-Info.plist"; \
	if [ ! -f "$$SRC_PLIST" ]; then \
		echo "  Warning: OpenMeshGo-Framework-Info.plist not found at $$SRC_PLIST, skip."; \
	else \
		for plist in "$$XCFW"/*/$(FRAMEWORK_NAME).framework/Resources/Info.plist; do \
			if [ -f "$$plist" ]; then cp "$$SRC_PLIST" "$$plist" && echo "  Updated $$plist"; fi; \
		done; \
	fi
	@echo "Moving framework to openmesh-apple/lib..."
	@rm -rf "$(OPENMESH_APPLE_LIB)/$(FRAMEWORK_NAME).xcframework"
	@mkdir -p "$(OPENMESH_APPLE_LIB)"
	@mv "$(CURDIR)/lib/$(FRAMEWORK_NAME).xcframework" "$(OPENMESH_APPLE_LIB)/"
	@echo "âœ… Fast build done: $(OPENMESH_APPLE_LIB)/$(FRAMEWORK_NAME).xcframework"

# ä»… libboxï¼ˆVPNï¼‰ï¼Œä¸å«é’±åŒ… interfaceï¼›äº§ç‰©æ›´å°ï¼Œä»…åœ¨éœ€è¦ä»… VPN æ„å»ºæ—¶ä½¿ç”¨ã€‚

# ä»… libboxï¼ˆVPNï¼‰ï¼Œä¸å«é’±åŒ… interfaceï¼›äº§ç‰©æ›´å°ï¼Œä»…åœ¨éœ€è¦ä»… VPN æ„å»ºæ—¶ä½¿ç”¨ã€‚
apple-libbox-only: gomobile-init
	@mkdir -p ./lib
	@rm -rf ./lib/$(FRAMEWORK_NAME).xcframework
	@rm -rf "$(APPLE_BIND_DIR)/build"
	@echo "Building Apple XCFramework (libbox only) => ./lib/$(FRAMEWORK_NAME).xcframework"
	@cd "$(APPLE_BIND_DIR)" && MACOSX_DEPLOYMENT_TARGET=$(MACOS_VERSION) \
		GOPROXY="$(APPLE_GOPROXY)" GOSUMDB="$(APPLE_GOSUMDB)" GOFLAGS="$(APPLE_GOFLAGS)" \
		$(GOMOBILE) bind \
		-target=$(APPLE_TARGETS) \
		-iosversion=$(IOS_VERSION) \
		-prefix=$(OBJC_PREFIX) \
		$(APPLE_EXTRA_FLAGS) \
		$(GOMOBILE_TAGS_FLAG) \
		-o "$(APPLE_XCFRAMEWORK_ABS)" \
		github.com/sagernet/sing-box/experimental/libbox
	@XCFW="$(CURDIR)/lib/$(FRAMEWORK_NAME).xcframework"; \
	SRC_PLIST="$(CURDIR)/../openmesh-apple/OpenMeshGo-Framework-Info.plist"; \
	if [ -f "$$SRC_PLIST" ]; then \
		for plist in "$$XCFW"/*/$(FRAMEWORK_NAME).framework/Resources/Info.plist; do \
			if [ -f "$$plist" ]; then cp "$$SRC_PLIST" "$$plist" && echo "  Updated $$plist"; fi; \
		done; \
	fi
	@echo "Moving framework to openmesh-apple/lib (rm old + mv new)..."
	@rm -rf "$(OPENMESH_APPLE_LIB)/$(FRAMEWORK_NAME).xcframework"
	@mkdir -p "$(OPENMESH_APPLE_LIB)"
	@mv "$(CURDIR)/lib/$(FRAMEWORK_NAME).xcframework" "$(OPENMESH_APPLE_LIB)/"
	@echo "âœ… Done (libbox only): $(OPENMESH_APPLE_LIB)/$(FRAMEWORK_NAME).xcframework"

# Full clean rebuild for Apple (clean + go clean -cache + apple). Use when Go changes don't seem to apply.
apple-clean: clean
	@$(GO) clean -cache
	@$(MAKE) apple

# ç”Ÿæˆ Xcode ç›´æ¥å¯ç”¨çš„ OpenMesh.xcframeworkï¼ˆçœŸæœº + æ¨¡æ‹Ÿå™¨ï¼‰
ios: gomobile-init
	@mkdir -p $(IOS_OUTPUT_DIR)
	@rm -rf $(IOS_XCFRAMEWORK)
	@echo "Building XCFramework => $(IOS_XCFRAMEWORK)"
	@echo "  BIND_DIR: $(APPLE_BIND_DIR)"
	@echo "  PKGS: $(APPLE_PKGS)"
	@echo "  TARGETS: $(IOS_TARGETS)"
	@echo "  GO_TAGS: $(GO_TAGS)"
	@cd "$(APPLE_BIND_DIR)" && GOFLAGS="$(APPLE_GOFLAGS)" \
		$(GOMOBILE) bind \
		-target=$(IOS_TARGETS) \
		-iosversion=$(IOS_VERSION) \
		-prefix=$(OBJC_PREFIX) \
		$(APPLE_EXTRA_FLAGS) \
		$(GOMOBILE_TAGS_FLAG) \
		-o ../$(IOS_XCFRAMEWORK) \
		$(APPLE_PKGS)
	@echo "âœ… Done: $(IOS_XCFRAMEWORK)"

# æ›´å¿«çš„æœ¬åœ°éªŒè¯ï¼šåªç¼–è¯‘ Apple Silicon æ¨¡æ‹Ÿå™¨ï¼ˆarm64-simulatorï¼‰ï¼Œè·‘ UI/è°ƒè¯•æ›´å¿«
# å¦‚æœä½ åœ¨ Intel Mac ä¸Šï¼ŒæŠŠ iossimulator/arm64 æ”¹æˆ iossimulator/amd64
ios-fast-sim: gomobile-init
	@mkdir -p $(IOS_OUTPUT_DIR)
	@rm -rf $(IOS_XCFRAMEWORK)
	@echo "Building FAST Simulator-only XCFramework (arm64 simulator) => $(IOS_XCFRAMEWORK)"
	@cd "$(APPLE_BIND_DIR)" && GOFLAGS="$(APPLE_GOFLAGS)" \
		$(GOMOBILE) bind \
		-target=iossimulator/arm64 \
		-iosversion=$(IOS_VERSION) \
		-prefix=$(OBJC_PREFIX) \
		$(APPLE_EXTRA_FLAGS) \
		$(GOMOBILE_TAGS_FLAG) \
		-o ../$(IOS_XCFRAMEWORK) \
		$(APPLE_PKGS)
	@echo "âœ… Done (sim-only): $(IOS_XCFRAMEWORK)"

# ä¸º macOS æ„å»ºå•ç‹¬çš„ xcframework
macos: gomobile-init
	@mkdir -p $(MACOS_OUTPUT_DIR)
	@rm -rf $(MACOS_XCFRAMEWORK)
	@echo "Building macOS XCFramework => $(MACOS_XCFRAMEWORK)"
	@cd "$(APPLE_BIND_DIR)" && MACOSX_DEPLOYMENT_TARGET=$(MACOS_VERSION) \
		GOPROXY="$(APPLE_GOPROXY)" GOSUMDB="$(APPLE_GOSUMDB)" GOFLAGS="$(APPLE_GOFLAGS)" \
		$(GOMOBILE) bind \
		-target=$(MACOS_TARGETS) \
		-prefix=$(OBJC_PREFIX) \
		$(APPLE_EXTRA_FLAGS) \
		$(GOMOBILE_TAGS_FLAG) \
		-o $(MACOS_XCFRAMEWORK) \
		$(APPLE_PKGS)
	@echo "âœ… Done: $(MACOS_XCFRAMEWORK)"

# ä¸º macOS æ„å»ºé€šç”¨ xcframeworkï¼ˆåŒ…å«å¤šç§æ¶æ„ï¼‰
macos-all: gomobile-init
	@mkdir -p $(MACOS_OUTPUT_DIR)
	@rm -rf $(MACOS_XCFRAMEWORK)
	@echo "Building Universal macOS XCFramework => $(MACOS_XCFRAMEWORK)"
	@cd "$(APPLE_BIND_DIR)" && MACOSX_DEPLOYMENT_TARGET=$(MACOS_VERSION) \
		GOPROXY="$(APPLE_GOPROXY)" GOSUMDB="$(APPLE_GOSUMDB)" GOFLAGS="$(APPLE_GOFLAGS)" \
		$(GOMOBILE) bind \
		-target=$(MACOS_TARGETS) \
		-prefix=$(OBJC_PREFIX) \
		$(APPLE_EXTRA_FLAGS) \
		$(GOMOBILE_TAGS_FLAG) \
		-o $(MACOS_XCFRAMEWORK) \
		$(APPLE_PKGS)
	@echo "âœ… Done: $(MACOS_XCFRAMEWORK)"

# ä¸º Android æ„å»º AAR æ–‡ä»¶
android: gomobile-init
	@mkdir -p $(ANDROID_OUTPUT_DIR)
	@echo "Building Android AAR => $(ANDROID_OUTPUT_DIR)/$(FRAMEWORK_NAME).aar"
	@$(GOMOBILE) bind \
		-target=android \
		-o $(ANDROID_OUTPUT_DIR)/$(FRAMEWORK_NAME).aar \
		$(PKG)
	@echo "âœ… Done: $(ANDROID_OUTPUT_DIR)/$(FRAMEWORK_NAME).aar"

test:
	@echo "Running go test..."
	@GOCACHE=/tmp/openmesh-go-build-cache $(GO) test ./... -count=1

clean:
	@rm -rf ./lib
	@rm -rf "$(APPLE_BIND_DIR)/build"
	@echo "Cleaned: ./lib and $(APPLE_BIND_DIR)/build"

help:
	@echo "make doctor        - æ£€æŸ¥ go / xcode / gomobile ç¯å¢ƒ"
	@echo "make tools         - å®‰è£… gomobile/gobind"
	@echo "make apple           - ç”Ÿæˆç»Ÿä¸€ OpenMeshGo.xcframework (libbox+é’±åŒ… interface, ios+sim+macos)"
	@echo "make apple FORCE_GO_CACHE_CLEAN=1 - åŒä¸Šï¼Œä¸”æ¸…é™¤ Go ç¼“å­˜ï¼Œç¡®ä¿ Go ä»£ç å˜æ›´ç”Ÿæ•ˆ"
	@echo "make apple-clean   - clean + go clean -cache + appleï¼ˆGo æ”¹åŠ¨æœªç”Ÿæ•ˆæ—¶ç”¨ï¼‰"
	@echo "make apple-libbox-only - ä»… libboxï¼ˆVPNï¼‰ï¼Œä¸å«é’±åŒ…ï¼Œäº§ç‰©æ›´å°"
	@echo "make ios             - ç”Ÿæˆ OpenMesh.xcframework (ios + iossimulator, iOS>=15)"
	@echo "make ios-fast-sim  - å¿«é€ŸéªŒè¯ï¼šä»…ç”Ÿæˆæ¨¡æ‹Ÿå™¨ arm64 çš„ xcframework"
	@echo "make macos         - ç”Ÿæˆ OpenMesh.xcframework (macOS, macOS>=13)"
	@echo "make macos-all     - ç”Ÿæˆé€šç”¨ OpenMesh.xcframework (macOS, macOS>=13)"
	@echo "make android       - ç”Ÿæˆ OpenMesh.aar (Android)"
	@echo "make test          - go test ./..."
	@echo "make clean         - æ¸…ç†äº§ç‰©"
